﻿@using System.Collections.Generic;
@using Sandbox;
@using Sandbox.UI;
@using Sandbox.Services;
@using Sandbox.Utility;
@inherits PanelComponent
@implements Component.INetworkListener
@namespace GeneralGame

<root>
	<div class="output">
		@foreach (var entry in Entries)
		{
			<div class="chat_entry">
				<div class="author">@entry.author</div>:
				<div class="message">@entry.message</div>
			</div>
		}
	</div>
	<div class="tool">Current Tool: @Tools[ind]</div>
	<div class="info">ping: @Networking.HostConnection.Ping</div>
	<div class="crosshair" />
	<TextEntry @ref="InputBox" onsubmit="@ChatFinished"></TextEntry>
</root>

@code
{
	public record Entry( string author, string message, RealTimeSince timeSinceAdded );
	int ind = 0;
	string[] Tools = ["PhysGun", "Scale", "GravGun", "Remove", "Color"];
	private TextEntry InputBox { get; set; }
	
	private List<Entry> Entries { get; set; } = new();
	protected override void OnUpdate()
    {
		if (Input.Pressed("Drop")) {
			ind++;
			ind = ind % (int)Tools.Count();
		}
		if ( InputBox is null )
			return;

		Panel.AcceptsFocus = false;

		if ( Input.Pressed( "chat" ) )
		{
			InputBox.Focus();
		}

		if ( Entries.RemoveAll( x => x.timeSinceAdded > 30f ) > 0 )
		{
			StateHasChanged();
		}

		SetClass( "open", InputBox.HasFocus );
		StateHasChanged();
	}

	private void ChatFinished()
	{
		var text = InputBox.Text;
		InputBox.Text = "";

		if ( string.IsNullOrWhiteSpace( text ) )
			return;

		SendText( Sandbox.Utility.Steam.PersonaName, text );
	}

	[Broadcast]
	private void SendText( string author, string message )
	{
		AddTextLocal( author, message );
	}

	public void AddTextLocal( string author, string message )
	{
		message = message.Truncate( 300 );

		if ( string.IsNullOrWhiteSpace( message ) )
			return;

		Log.Info( $"{author}: {message}" );

		Entries.Add( new ( author, message, 0f ) );
		StateHasChanged();
	}
}
